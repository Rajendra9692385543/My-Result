<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Section Wise Credit Report</title>
  <link rel="icon" type="image/png" href="/static/exam-results2.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4>üìä Basket Wise Credit Report</h4>
      <a href="/credit-tracker" class="btn btn-outline-secondary">‚Üê Back</a>
    </div>

    <!-- üìù Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- üîé Form -->
    <form method="POST" class="card p-4 shadow-sm mb-4">
      <div class="row g-3">
        <h6>Enter a range of up to 30 students at once</h6>
        <div class="col-md-3">
          <label class="form-label"><strong>School</strong></label>
          <select id="schoolSelect" name="school" class="form-select" required>
            <option value="">Select School</option>
            {% for s in schools %}
              <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label"><strong>Program</strong></label>
          <select id="programSelect" name="program" class="form-select" required>
            <option value="">Select Program</option>
            {% for p in programs %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label"><strong>Branch</strong></label>
          <select id="branchSelect" name="branch" class="form-select" required>
            <option value="">Select Branch</option>
            {% for b in branches %}
              <option value="{{ b }}">{{ b }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label"><strong>Start Reg. No</strong></label>
          <input type="text" name="start_reg" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label"><strong>End Reg. No</strong></label>
          <input type="text" name="end_reg" class="form-control" required>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Generate Report</button>
        </div>
      </div>
    </form>

    <!-- üì• Download options -->
    {% if data %}
    <div class="d-flex justify-content-end mb-2">
      <div class="dropdown">
        <button class="btn btn-success dropdown-toggle" type="button" id="downloadMenu" data-bs-toggle="dropdown" aria-expanded="false">
          ‚¨á Download
        </button>
        <ul class="dropdown-menu" aria-labelledby="downloadMenu">
          <li><a class="dropdown-item" href="{{ url_for('download_basket_excel') }}">Download as Excel</a></li>
          <li><a class="dropdown-item" href="{{ url_for('download_basket_pdf') }}">Download as PDF</a></li>
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- üìä Report Table -->
{% if data %}
<style>
  table th, table td {
    padding: 10px 14px !important;
    vertical-align: middle;
    text-align: center;
    font-size: 14px;
    white-space: nowrap;
  }
  thead th {
    background-color: #f8f9fa;
    font-weight: 600;
  }
  .table-container {
    overflow-x: auto;
    position: relative;
  }
  /* ‚úÖ Freeze Name & Reg. No columns */
  th.sticky-col, td.sticky-col {
    position: sticky;
    background: #fff;
    z-index: 2;
  }
  th.sticky-name, td.sticky-name { left: 0; min-width: 180px; }
  th.sticky-reg, td.sticky-reg { left: 180px; min-width: 160px; }
</style>

<div class="table-container">
  <table class="table table-bordered align-middle">
    <thead class="table-light text-center">
      <!-- First row: group headers -->
      <tr>
        <th rowspan="2">Sl.No</th>
        <th rowspan="2" class="sticky-col sticky-name">Name</th>
        <th rowspan="2" class="sticky-col sticky-reg">Registration No</th>
        <th rowspan="2">Department</th>
        {% for basket in baskets %}
          <th colspan="2">{{ basket }}</th>
        {% endfor %}
        <th colspan="2">Total</th>
        <th rowspan="2">Pending Credits</th>
        <th rowspan="2">Backlog Credits</th>
      </tr>
      <!-- Second row: sub headers -->
      <tr>
        {% for basket in baskets %}
          <th>Earned</th>
          <th>Max</th>
        {% endfor %}
        <th>Earned</th>
        <th>Max</th>
      </tr>
    </thead>
    <tbody>
      {% for student in data %}
      <tr>
        <td>{{ loop.index }}</td>
        <td class="sticky-col sticky-name">{{ student.name }}</td>
        <td class="sticky-col sticky-reg">{{ student.reg_no }}</td>
        <td>{{ student.branch }}</td>

        {% for basket in baskets %}
          {% set earned = student.baskets.get(basket, 0) %}
          {% set maxc = basket_max.get(basket, 0) %}
          <td class="{% if earned == maxc %}table-success{% elif earned < maxc %}table-warning{% endif %}">
            {{ earned }}
          </td>
          <td class="table-secondary">{{ maxc }}</td>
        {% endfor %}

        <td class="{% if student.total == total_max %}table-success{% elif student.total < total_max %}table-warning{% endif %}">
          {{ student.total }}
        </td>
        <td class="table-secondary">{{ total_max }}</td>

        <td class="text-warning fw-bold">{{ student.pending_credits }}</td>
        <td class="text-danger fw-bold">{{ student.backlog_credits }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Dynamic dropdown logic
    const schoolBranchMap = {{ schoolBranchMap|tojson }};
    const schoolProgramMap = {{ schoolProgramMap|tojson }};
    
    const schoolSelect = document.getElementById('schoolSelect');
    const branchSelect = document.getElementById('branchSelect');
    const programSelect = document.getElementById('programSelect');

    schoolSelect.addEventListener('change', () => {
      const selectedSchool = schoolSelect.value;

      // Update branches
      branchSelect.innerHTML = '<option value="">Select Branch</option>';
      if (selectedSchool in schoolBranchMap) {
        schoolBranchMap[selectedSchool].forEach(branch => {
          const opt = document.createElement('option');
          opt.value = branch;
          opt.text = branch;
          branchSelect.appendChild(opt);
        });
      }

      // Update programs
      programSelect.innerHTML = '<option value="">Select Program</option>';
      if (selectedSchool in schoolProgramMap) {
        schoolProgramMap[selectedSchool].forEach(prog => {
          const opt = document.createElement('option');
          opt.value = prog;
          opt.text = prog;
          programSelect.appendChild(opt);
        });
      }
    });
  </script>
</body>
</html>
